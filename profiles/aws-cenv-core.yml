parents:
  - aws-network

config:
  admin_subnet_cidr_prefix: 28
  admin_subnet_public_ip: true

  admin_server_name: cenv
  admin_group: cenv

  aws_admin_subnets:
    - admin-1
    - admin-2
    - admin-3

  aws_admin_machine: t2.micro
  aws_admin_tenancy: default
  aws_admin_monitoring: false
  aws_admin_ebs_optimized: false

  admin_port: 5123

  cenv_database: "%%cenv_database:30"
  cenv_database_user: "%%cenv_database_user:30"
  cenv_password: "%%cenv_password:30"

group:
  "@admin_group":

subnet:
  admin-1:
    when_in: "@aws_admin_subnets"
    network: "@aws_networks"
    cidr_prefix: "@admin_subnet_cidr_prefix"
    zone_suffix: a
    use_public_ip: "@admin_subnet_public_ip"
    groups: "@admin_group"

  admin-2:
    when_in: "@aws_admin_subnets"
    network: "@aws_networks"
    cidr_prefix: "@admin_subnet_cidr_prefix"
    zone_suffix: b
    use_public_ip: "@admin_subnet_public_ip"
    groups: "@admin_group"

  admin-3:
    when_in: "@aws_admin_subnets"
    network: "@aws_networks"
    cidr_prefix: "@admin_subnet_cidr_prefix"
    zone_suffix: c
    use_public_ip: "@admin_subnet_public_ip"
    groups: "@admin_group"

firewall:
  admin-external:
    network: "@aws_networks"
    groups: "@admin_group"
    rules:
      tcp_in:
        mode: ingress
        protocol: tcp
        from_port: "@admin_port"
        to_port: "@admin_port"

  admin-internal:
    requires: admin-external
    network: "@aws_networks"
    groups: "@admin_group"
    rules:
      tcp_in:
        mode: ingress
        protocol: tcp
        from_port: "@admin_port"
        to_port: "@admin_port"
        source_firewall: admin-external

provision:
  cenv-credentials:
    command: server rotate
    server_search: groups.name=@admin_group

  cenv-user-environment:
    requires: cenv-credentials
    task: user-environment
    servers: groups.name=@admin_group

  cenv-app-environment:
    requires: cenv-credentials
    task: environment
    servers: groups.name=@admin_group
    env:
      CENV_DEFAULT_ENV_NAME: "@environment"
      CENV_DEFAULT_RUNTIME_REPO: "@DEFAULT_RUNTIME_REPO"
      CENV_DEFAULT_RUNTIME_IMAGE: "@DEFAULT_RUNTIME_IMAGE"
      CENV_SECRET_KEY: "%%cenv_secret_key:50"
      CENV_PARALLEL: "@PARALLEL"
      CENV_THREAD_COUNT: "@THREAD_COUNT"
      CENV_TIME_ZONE: "@primary_timezone"
      CENV_CORE_MODULE: "@CORE_MODULE"
      CENV_DB_PACKAGE_ALL_NAME: "@DB_PACKAGE_ALL_NAME"
      CENV_DB_MAX_CONNECTIONS: "@DB_MAX_CONNECTIONS"
      CENV_LOG_LEVEL: "@LOG_LEVEL"
      CENV_ALLOWED_HOSTS: "@ALLOWED_HOSTS"
      CENV_ADMIN_USER: "@ADMIN_USER"
      CENV_DEFAULT_ADMIN_TOKEN: "%%cenv_default_admin_token:60"

  cenv-cluster:
    requires: cenv-app-environment
    task: bootstrap
    servers: groups.name=@admin_group
    ntp_timezone: "@primary_timezone"
    app_user: "@aws_ubuntu_user"
    docker_users:
      - "@aws_ubuntu_user"

  cenv-wait:
    requires: cenv-cluster
    task: sleep
    number: 1
    unit: m

  deploy-cenv:
    requires: cenv-wait
    command: deploy
    server_search: id=&server(network=@aws_networks[0];subnet=@aws_admin_subnets[0]):@{admin_server_name}1:id
    host: "&server(network=@aws_networks[0];subnet=@aws_admin_subnets[0]):@{admin_server_name}1:ip"
